import telebot
from telebot import types
from collections import defaultdict
import logging
from config import TOKEN  # –ò–º–ø–æ—Ä—Ç —Ç–æ–∫–µ–Ω–∞ –∏–∑ —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', filename='bot_log.log')
logger = logging.getLogger(__name__)

bot = telebot.TeleBot(TOKEN)

# –í–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
questions = [
    ("–í–∞—à –∏–¥–µ–∞–ª—å–Ω—ã–π –¥–µ–Ω—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å...", {
        "–ü—Ä–æ–≥—É–ª–∫–∏ –Ω–∞ —Å–≤–µ–∂–µ–º –≤–æ–∑–¥—É—Ö–µ": "–ê",
        "–ú–µ–¥–∏—Ç–∞—Ü–∏–∏ –∏–ª–∏ —á—Ç–µ–Ω–∏—è": "–ë",
        "–ê–∫—Ç–∏–≤–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏": "–í",
        "–í—Å—Ç—Ä–µ—á–∏ —Å –¥—Ä—É–∑—å—è–º–∏": "–ì"
    }),

    ("–ö–∞–∫–∞—è —Å—Ç–∏—Ö–∏—è –≤–∞–º –±–ª–∏–∂–µ –≤—Å–µ–≥–æ?", {
        "–û–≥–æ–Ω—å": "–ê",
        "–í–æ–¥–∞": "–ë",
        "–ó–µ–º–ª—è": "–í",
        "–í–æ–∑–¥—É—Ö": "–ì"
    }),

    ("–í–∞—à–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ —Ä–∏—Å–∫—É...", {
        "–õ—é–±–ª—é –∏—Å–ø—ã—Ç—ã–≤–∞—Ç—å —Å—É–¥—å–±—É": "–ê",
        "–û—Å—Ç–æ—Ä–æ–∂–Ω–æ –≤–∑–≤–µ—à–∏–≤–∞—é –≤—Å–µ –ó–ê –∏ –ü–†–û–¢–ò–í": "–ë",
        "–ò–∑–±–µ–≥–∞—é —Ä–∏—Å–∫–æ–≤, –≥–¥–µ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ": "–í",
        "–†–∏—Å–∫ - —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–ª—è —Ä–æ—Å—Ç–∞": "–ì"
    }),

    ("–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à–µ –ª—é–±–∏–º–æ–µ –≤—Ä–µ–º—è —Å—É—Ç–æ–∫?", {
        "–£—Ç—Ä–æ": "–ê",
        "–î–µ–Ω—å": "–ë",
        "–í–µ—á–µ—Ä": "–í",
        "–ù–æ—á—å": "–ì"
    }),

    ("–ö–∞–∫ –≤—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ—Å—å –∫ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤—É?", {
        "–¶–µ–Ω—é –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–±—ã—Ç—å –æ–¥–Ω–æ–º—É": "–ê",
        "–ò–Ω–æ–≥–¥–∞ –Ω—É–∂–¥–∞—é—Å—å –≤ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–µ, –Ω–æ –Ω–µ —á–∞—Å—Ç–æ": "–ë",
        "–°—Ç–∞—Ä–∞—é—Å—å –∏–∑–±–µ–≥–∞—Ç—å": "–í",
        "–ù–µ –ª—é–±–ª—é –±—ã—Ç—å –æ–¥–∏–Ω–æ–∫–∏–º": "–ì"
    }),

    ("–ö–∞–∫–æ–π –∏–∑ —ç—Ç–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤–∞–º –Ω–∞–∏–±–æ–ª–µ–µ –∏–Ω—Ç–µ—Ä–µ—Å–µ–Ω?", {
        "–ö–Ω–∏–≥–∏": "–ê",
        "–û–≥–æ–Ω—å": "–ë",
        "–í–æ–¥–∞": "–í",
        "–ö–∞–º–Ω–∏": "–ì"
    }),

    ("–í–∞—à–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º...", {
        "–í—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç –Ω–æ–≤—ã–º –∏–¥–µ—è–º": "–ê",
        "–ê–∫–∫—É—Ä–∞—Ç–Ω–æ –∞–¥–∞–ø—Ç–∏—Ä—É—é—Å—å –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º": "–ë",
        "–°–∫–µ–ø—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–Ω–æ—à—É—Å—å –∫ –Ω–æ–≤–æ–º—É": "–í",
        "–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—É–≥–∞—é—Ç –º–µ–Ω—è": "–ì"
    }),

    ("–ö–∞–∫–æ–π –ª–∞–Ω–¥—à–∞—Ñ—Ç –≤–∞–º –ø–æ –¥—É—à–µ?", {
        "–ì–æ—Ä—ã": "–ê",
        "–õ–µ—Å": "–ë",
        "–ü—É—Å—Ç—ã–Ω—è": "–í",
        "–û–∫–µ–∞–Ω": "–ì"
    }),

    ("–ß—Ç–æ –¥–ª—è –≤–∞—Å –≤–∞–∂–Ω–µ–µ –≤—Å–µ–≥–æ?", {
        "–°–µ–º—å—è": "–ê",
        "–ö–∞—Ä—å–µ—Ä–∞": "–ë",
        "–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ": "–í",
        "–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è": "–ì"
    }),

    ("–ö–∞–∫ –≤—ã –æ–±—ã—á–Ω–æ —Ä–µ—à–∞–µ—Ç–µ –ø—Ä–æ–±–ª–µ–º—ã?", {
        "–ò–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ": "–ê",
        "–õ–æ–≥–∏—á–µ—Å–∫–∏": "–ë",
        "–°–æ–≤–µ—Ç—É—é—Å—å —Å –¥—Ä—É–∑—å—è–º–∏": "–í",
        "–ò–∑–±–µ–≥–∞—é –∫–æ–Ω—Ñ—Ä–æ–Ω—Ç–∞—Ü–∏–∏": "–ì"
    }),
]

# –°–ª–µ–¥–∏–º –∑–∞ –≤—ã–±–æ—Ä–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
user_choices = defaultdict(lambda: defaultdict(int))
user_current_question = defaultdict(int)
user_states = defaultdict(lambda: None)

def calculate_result(user_id):
    choices_count = user_choices[user_id]
    counts = {'–ê': 0, '–ë': 0, '–í': 0, '–ì': 0}
    for category in choices_count:
        counts[category] += choices_count[category]

    max_count = max(counts.values())
    max_categories = [cat for cat, count in counts.items() if count == max_count]

    totem_info = {
        '–ê': ("–í–æ–ª–∫ - —Å–∏–º–≤–æ–ª–∏–∑–∏—Ä—É–µ—Ç —Å–≤–æ–±–æ–¥—É –∏ –∏–Ω—Ç—É–∏—Ü–∏—é. –í–æ–ª–∫–∏ –∏–∑–≤–µ—Å—Ç–Ω—ã —Å–≤–æ–µ–π —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω–æ—Å—Ç—å—é, –∂–∏–≤—É—Ç –∏ –æ—Ö–æ—Ç—è—Ç—Å—è –≤ —Å—Ç–∞—è—Ö, —á—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –æ –∏—Ö –≥–ª—É–±–æ–∫–∏—Ö —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–≤—è–∑—è—Ö. –û–Ω–∏ –æ–±–ª–∞–¥–∞—é—Ç –≤—ã–¥–∞—é—â–∏–º–∏—Å—è –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è–º–∏, –ø–æ–º–æ–≥–∞—é—â–∏–º–∏ –∏–º –≤—ã–∂–∏–≤–∞—Ç—å –≤ –¥–∏–∫–æ–π –ø—Ä–∏—Ä–æ–¥–µ. –í–æ–ª–∫ —Ç–∞–∫–∂–µ —è–≤–ª—è–µ—Ç—Å—è —Å–∏–º–≤–æ–ª–æ–º —Å–≤–æ–±–æ–¥—ã –¥—É—Ö–∞, —Å–º–µ–ª–æ—Å—Ç–∏ –∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, –æ–Ω –Ω–µ –±–æ–∏—Ç—Å—è –∏–¥—Ç–∏ —Å–≤–æ–∏–º –ø—É—Ç–µ–º.", "https://media.istockphoto.com/id/177794699/ru/%D1%84%D0%BE%D1%82%D0%BE/%D1%81%D0%B5%D1%80%D1%8B%D0%B9-%D0%B2%D0%BE%D0%BB%D0%BA-%D0%BF%D0%BE%D1%80%D1%82%D1%80%D0%B5%D1%82.jpg?s=612x612&w=0&k=20&c=zTMmfuCxFPLGdvQkmS3Xb6MVY7E-wk5nf3lnuVbTc4Q="),
        '–ë': ("–ú–µ–¥–≤–µ–¥—å - –æ–ª–∏—Ü–µ—Ç–≤–æ—Ä—è–µ—Ç —Å–∏–ª—É –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å. –ú–µ–¥–≤–µ–¥—å ‚Äî –º–æ—â–Ω–æ–µ –∏ –≤–Ω—É—à–∞—é—â–µ–µ —É–≤–∞–∂–µ–Ω–∏–µ –∂–∏–≤–æ—Ç–Ω–æ–µ, –∫–æ—Ç–æ—Ä–æ–µ —Å–∏–º–≤–æ–ª–∏–∑–∏—Ä—É–µ—Ç –ª–∏–¥–µ—Ä—Å—Ç–≤–æ –∏ —Å–∏–ª—É. –û–Ω —Ç–∞–∫–∂–µ –∞—Å—Å–æ—Ü–∏–∏—Ä—É–µ—Ç—Å—è —Å –∑–∞—â–∏—Ç–æ–π, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é –∏ —Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å—é. –ú–µ–¥–≤–µ–¥–∏ —Å–ø–æ—Å–æ–±–Ω—ã –∫ –≥–ª—É–±–æ–∫–æ–º—É —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—é –∏ –º–µ–¥–∏—Ç–∞—Ü–∏–∏, –æ—Å–æ–±–µ–Ω–Ω–æ –≤–æ –≤—Ä–µ–º—è –∑–∏–º–Ω–µ–π —Å–ø—è—á–∫–∏, —á—Ç–æ –æ—Ç—Ä–∞–∂–∞–µ—Ç –∏—Ö —Å–≤—è–∑—å —Å –±–æ–ª–µ–µ –≥–ª—É–±–æ–∫–∏–º–∏ —É—Ä–æ–≤–Ω—è–º–∏ —Å–æ–∑–Ω–∞–Ω–∏—è –∏ –∏–Ω—Ç—É–∏—Ü–∏–µ–π.", "https://img.freepik.com/free-photo/majestic-large-mammal-walking-in-snowy-forest-generative-ai_188544-36924.jpg"),
        '–í': ("–õ–æ—à–∞–¥—å - —Å–∏–º–≤–æ–ª —Å–≤–æ–±–æ–¥—ã –∏ –º–æ—â–∏. –õ–æ—à–∞–¥–∏ ‚Äî —Å—É—â–µ—Å—Ç–≤–∞, –∏–∑–ª—É—á–∞—é—â–∏–µ —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ—Å—Ç—å –∏ –º–æ—â—å, —Å–ø–æ—Å–æ–±–Ω—ã–µ –±—ã—Å—Ç—Ä–æ –¥–≤–∏–≥–∞—Ç—å—Å—è –∏ –ø—Ä–µ–æ–¥–æ–ª–µ–≤–∞—Ç—å –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è. –û–Ω–∏ —Ç–∞–∫–∂–µ –∞—Å—Å–æ—Ü–∏–∏—Ä—É—é—Ç—Å—è —Å–æ —Å–≤–æ–±–æ–¥–æ–π, –ø–æ—Å–∫–æ–ª—å–∫—É –∏—Ö –≥—Ä–∞—Ü–∏–æ–∑–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –∏ —Å–∏–ª–∞ –¥—É—Ö–∞ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—Ç –Ω–∞ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –æ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –∏ —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Å–≤–æ–∏–º –∂–µ–ª–∞–Ω–∏—è–º.", "https://basetop.ru/wp-content/uploads/2019/03/itrttzwr.jpg"),
        '–ì': ("–°–æ–≤–∞ - –º—É–¥—Ä–æ—Å—Ç—å –∏ –∑–∞–≥–∞–¥–æ—á–Ω–æ—Å—Ç—å. –°–æ–≤—ã, —Å –∏—Ö —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å—é –≤–∏–¥–µ—Ç—å –≤ —Ç–µ–º–Ω–æ—Ç–µ, —Å–∏–º–≤–æ–ª–∏–∑–∏—Ä—É—é—Ç –≥–ª—É–±–æ–∫—É—é –∏–Ω—Ç—É–∏—Ü–∏—é –∏ –∑–Ω–∞–Ω–∏–µ —Ç–∞–π–Ω–æ–≥–æ. –≠—Ç–∏ –ø—Ç–∏—Ü—ã —á–∞—Å—Ç–æ –∞—Å—Å–æ—Ü–∏–∏—Ä—É—é—Ç—Å—è —Å –º—É–¥—Ä–æ—Å—Ç—å—é, –ø–æ—Å–∫–æ–ª—å–∫—É –∏—Ö –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –≤–∏–¥–µ—Ç—å —Ç–æ, —á—Ç–æ —Å–∫—Ä—ã—Ç–æ –æ—Ç –¥—Ä—É–≥–∏—Ö, –¥–µ–ª–∞–µ—Ç –∏—Ö —Å–∏–º–≤–æ–ª–æ–º –∑–Ω–∞–Ω–∏—è –∏ –∑–∞–≥–∞–¥–æ—á–Ω–æ—Å—Ç–∏.", "https://img.freepik.com/premium-photo/beautiful-owl_254845-8286.jpg"),
        ('–ê', '–ë'): ("–û–ª–µ–Ω—å - –∏–∑—è—â–µ—Å—Ç–≤–æ –∏ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ. –û–ª–µ–Ω–∏ ‚Äî —ç–ª–µ–≥–∞–Ω—Ç–Ω—ã–µ –∂–∏–≤–æ—Ç–Ω—ã–µ, –¥–≤–∏–∂–µ–Ω–∏—è –∫–æ—Ç–æ—Ä—ã—Ö –Ω–∞–ø–æ–ª–Ω–µ–Ω—ã –≥—Ä–∞—Ü–∏–µ–π –∏ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ–º. –û–Ω–∏ –Ω–∞–ø–æ–º–∏–Ω–∞—é—Ç –æ –≤–∞–∂–Ω–æ—Å—Ç–∏ –±—ã—Ç—å –ª–µ–≥–∫–∏–º –Ω–∞ –ø–æ–¥—ä–µ–º –∏ —Å–ø–æ—Å–æ–±–Ω—ã–º –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–∏ —ç—Ç–æ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ –∏ –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–æ.", "https://media.istockphoto.com/id/140157656/ru/%D1%84%D0%BE%D1%82%D0%BE/%D0%BF%D0%BE%D1%80%D1%82%D1%80%D0%B5%D1%82-%D0%B2%D0%B5%D0%BB%D0%B8%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%B5%D0%BD%D0%BD%D1%8B%D0%B9-%D0%BA%D1%80%D0%B0%D1%81%D0%BD%D1%8B%D0%B9-%D0%BE%D0%BB%D0%B5%D0%BD%D1%8C-%D0%BE%D0%BB%D0%B5%D0%BD%D1%8C-%D0%B2-%D0%BE%D1%81%D0%B5%D0%BD%D1%8C-%D0%BE%D1%81%D0%B5%D0%BD%D1%8C.jpg?s=612x612&w=0&k=20&c=rCL1dxZz0DdUgcxYEH5a9VZzSpRV15Wx4RY9A_91ovE="),
        ('–ê', '–í'): ("–î–µ–ª—å—Ñ–∏–Ω - –∏–≥—Ä–∏–≤–æ—Å—Ç—å –∏ –≥–∞—Ä–º–æ–Ω–∏—è. –î–µ–ª—å—Ñ–∏–Ω—ã –∏–∑–≤–µ—Å—Ç–Ω—ã —Å–≤–æ–µ–π –¥—Ä—É–∂–µ–ª—é–±–Ω–æ—Å—Ç—å—é, –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–æ–º –∏ –ª—é–±–æ–ø—ã—Ç—Å—Ç–≤–æ–º. –û–Ω–∏ –Ω–∞–ø–æ–º–∏–Ω–∞—é—Ç –æ –≤–∞–∂–Ω–æ—Å—Ç–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –ª–µ–≥–∫–æ—Å—Ç—å –±—ã—Ç–∏—è, –Ω–∞—Å–ª–∞–∂–¥–∞—Ç—å—Å—è –æ–±—â–µ–Ω–∏–µ–º –∏ –Ω–∞—Ö–æ–¥–∏—Ç—å —Ä–∞–¥–æ—Å—Ç—å –≤ –ø—Ä–æ—Å—Ç—ã—Ö –≤–µ—â–∞—Ö, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—è –ø—Ä–∏ —ç—Ç–æ–º –≥–∞—Ä–º–æ–Ω–∏—é —Å –æ–∫—Ä—É–∂–∞—é—â–∏–º –º–∏—Ä–æ–º.", "https://img.freepik.com/free-photo/beautiful-dolphin-jumping-out-of-water_23-2150770795.jpg"),
        ('–ê', '–ì'): ("–ü—É–º–∞ - —Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å. –ü—É–º—ã ‚Äî —Å–∏–ª—å–Ω—ã–µ –∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ —Ö–∏—â–Ω–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É—é—Ç—Å—è —Å–≤–æ–µ–π –∏–Ω—Ç—É–∏—Ü–∏–µ–π –∏ –∏–º–µ—é—Ç —Å–∏–ª—å–Ω—ã–π –¥—É—Ö. –û–Ω–∏ –æ–ª–∏—Ü–µ—Ç–≤–æ—Ä—è—é—Ç —Å–º–µ–ª–æ—Å—Ç—å –∏–¥—Ç–∏ —Å–≤–æ–∏–º", "https://media.istockphoto.com/id/1392544996/ru/%D1%84%D0%BE%D1%82%D0%BE/%D0%BF%D1%83%D0%BC%D0%B0-%D0%BF%D0%BE%D1%80%D1%82%D1%80%D0%B5%D1%82-%D0%BA%D1%80%D1%83%D0%BF%D0%BD%D1%8B%D0%BC-%D0%BF%D0%BB%D0%B0%D0%BD%D0%BE%D0%BC.jpg?s=612x612&w=0&k=20&c=6O2DD9DtRtRcjrlrZjXdONhEZK67Bn_rhjFG8YKAfP4="),
        ('–ë', '–í'): ("–û—Ä—ë–ª - —Å–∏–º–≤–æ–ª–∏–∑–∏—Ä—É–µ—Ç –æ—Å—Ç—Ä–æ—Ç—É –∑—Ä–µ–Ω–∏—è –∏ —Å–≤–æ–±–æ–¥—É –¥—É—Ö–∞. –û—Ä–ª—ã –æ–±–ª–∞–¥–∞—é—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å—é –≤–∏–¥–µ—Ç—å —Ü–µ–ª–∏ –Ω–∞ –±–æ–ª—å—à–æ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏, –Ω–µ —Ç–µ—Ä—è—è –ø—Ä–∏ —ç—Ç–æ–º —Å–≤—è–∑–∏ —Å –∑–µ–º–ª—ë–π. –≠—Ç–æ –∂–∏–≤–æ—Ç–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ—á–µ—Ç–∞—é—Ç –≤ —Å–µ–±–µ –∫–∞–∫ –º–æ—â—å, —Ç–∞–∫ –∏ –∫—Ä–∞—Å–æ—Ç—É, —Å–ø–æ—Å–æ–±–Ω—ã–µ –ø—Ä–∏—Å–ø–æ—Å–∞–±–ª–∏–≤–∞—Ç—å—Å—è –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º –∏ –ø—Ä–µ–æ–¥–æ–ª–µ–≤–∞—Ç—å –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è.", "https://static6.depositphotos.com/1000847/647/i/450/depositphotos_6474531-stock-photo-eagle-close-up.jpg"),
        ('–ë', '–ì'): ("–õ–∏—Å–∞ - –º–µ—Ç–∞—Ñ–æ—Ä–∞ —Ö–∏—Ç—Ä–æ—Å—Ç–∏ –∏ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏. –õ–∏—Å—ã –∏–∑–≤–µ—Å—Ç–Ω—ã —Å–≤–æ–µ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å—é –≤—ã–∂–∏–≤–∞—Ç—å –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö, –∏—Å–ø–æ–ª—å–∑—É—è –æ—Å—Ç—Ä—ã–π —É–º –∏ –∏–∑–æ–±—Ä–µ—Ç–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å. –û–Ω–∏ —Å–∏–º–≤–æ–ª–∏–∑–∏—Ä—É—é—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –Ω–∞—Ö–æ–¥–∏—Ç—å –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –∏ –ª–µ–≥–∫–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫ –Ω–æ–≤—ã–º –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞–º, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–∏ —ç—Ç–æ–º —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∏ —Å–∏–ª—É.", "https://media.istockphoto.com/id/516318760/ru/%D1%84%D0%BE%D1%82%D0%BE/red-fox-vulpes-vulpes.jpg?s=612x612&w=0&k=20&c=6ZbE9z2TK2Jf7ZuRzwZmm1p89jJebHCBe112cisRuj4="),
        ('–í', '–ì'): ("–ß–µ—Ä–µ–ø–∞—Ö–∞ - –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –º—É–¥—Ä–æ—Å—Ç—å, –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ –∏ —Å—Ç–æ–π–∫–æ—Å—Ç—å. –ß–µ—Ä–µ–ø–∞—Ö–∏ –∂–∏–≤—É—Ç –¥–æ–ª–≥–æ, –¥–≤–∏–≥–∞—é—Ç—Å—è –º–µ–¥–ª–µ–Ω–Ω–æ, –Ω–æ –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç–∏–≥–∞—é—Ç —Å–≤–æ–µ–π —Ü–µ–ª–∏ –±–ª–∞–≥–æ–¥–∞—Ä—è –Ω–µ–ø–æ–∫–æ–ª–µ–±–∏–º–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –≤ —Å–µ–±–µ –∏ —Å–≤–æ–∏—Ö —Å–∏–ª–∞—Ö. –û–Ω–∏ –Ω–∞–ø–æ–º–∏–Ω–∞—é—Ç –æ –≤–∞–∂–Ω–æ—Å—Ç–∏ —Ç–µ—Ä–ø–µ–Ω–∏—è, —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥ –ª–∏—Ü–æ–º —Ç—Ä—É–¥–Ω–æ—Å—Ç–µ–π –∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ –≤ –ª—é–±–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏.", "https://st.depositphotos.com/2021333/2715/i/450/depositphotos_27155705-stock-photo-green-sea-turtle.jpg"),
    }

    if len(max_categories) == 1:
        return totem_info[max_categories[0]]
    else:
        # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –¥–æ–±–∞–≤–∏–ª–∏ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ URL –≤ totem_info
        return totem_info[tuple(sorted(max_categories))]

@bot.message_handler(commands=['start', 'restart'])
def send_welcome(message):
    try:
        user_id = message.chat.id
        user_states[user_id] = None  # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        greeting = ("üåü –ü—Ä–∏–≤–µ—Ç! üåü\n"
                    "–•–æ—á–µ—à—å —É–∑–Ω–∞—Ç—å —Å–≤–æ–µ —Ç–æ—Ç–µ–º–Ω–æ–µ –∂–∏–≤–æ—Ç–Ω–æ–µ?\n"
                    "–ù–∞–∂–º–∏ '–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç'")
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
        markup.add('–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç')  # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∞
        bot.send_message(message.chat.id, greeting, reply_markup=markup)
        logger.info(f"User {message.from_user.id} started/restarted the bot")
    except Exception as e:
        logger.error(f"Error in send_welcome: {e}", exc_info=True)


@bot.message_handler(func=lambda message: user_states[message.from_user.id] == 'awaiting_feedback')
def handle_feedback(message):
    # –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º –æ—Ç–∑—ã–≤ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É –∑–æ–æ–ø–∞—Ä–∫–∞
    feedback_message = f"–û—Ç–∑—ã–≤ –æ—Ç @{message.from_user.username} (ID: {message.from_user.id}): {message.text}"
    bot.send_message(1885951903, feedback_message)  # ID —á–∞—Ç–∞ —Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º –∑–æ–æ–ø–∞—Ä–∫–∞
    bot.send_message(message.chat.id, "–í–∞—à –æ—Ç–∑—ã–≤ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ!")
    user_states[message.from_user.id] = None  # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

@bot.message_handler(func=lambda message: message.text == '–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤')
def request_feedback(message):
    bot.send_message(message.chat.id, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–∑—ã–≤. –û–Ω –±—É–¥–µ—Ç –ø–µ—Ä–µ—Å–ª–∞–Ω —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É –∑–æ–æ–ø–∞—Ä–∫–∞.")
    user_states[message.from_user.id] = 'awaiting_feedback'

def start_quiz(message):
    # –ù–∞—á–∏–Ω–∞–µ–º –∫–≤–∏–∑
    user_id = message.chat.id
    user_choices[user_id].clear()
    user_current_question[user_id] = 0
    user_states[user_id] = 'quiz_in_progress'  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ "–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∫–≤–∏–∑–∞"
    ask_question(message)

def ask_question(message):
    question_idx = user_current_question[message.chat.id]
    if question_idx < len(questions):
        question, answers = questions[question_idx]
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
        for answer in answers:
            markup.add(answer)
        markup.add('–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç –∑–∞–Ω–æ–≤–æ')
        bot.send_message(message.chat.id, question, reply_markup=markup)
    else:
        show_result(message)

@bot.message_handler(func=lambda message: message.text == '–°–≤—è–∑–∞—Ç—å—Å—è —Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º –∑–æ–æ–ø–∞—Ä–∫–∞')
def contact_zoo_staff(message):
    user_id = message.from_user.id
    user_username = message.from_user.username if message.from_user.username else "–∞–Ω–æ–Ω–∏–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    result_text, _ = calculate_result(user_id)
    contact_message = f"–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–≤—è–∑—å –æ—Ç @{user_username} (ID: {user_id}). –†–µ–∑—É–ª—å—Ç–∞—Ç –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã: {result_text}"
    bot.send_message(1885951903, contact_message)  # ID —á–∞—Ç–∞ —Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º –∑–æ–æ–ø–∞—Ä–∫–∞
    bot.send_message(user_id, "–í–∞—à –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–≤—è–∑—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞.")

@bot.message_handler(func=lambda message: True)
def handle_text(message):
    user_id = message.from_user.id

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ–∂–∏–¥–∞–µ—Ç—Å—è –ª–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–∑—ã–≤
    if user_states[user_id] == 'awaiting_feedback':
        handle_feedback(message)
        return

    if message.text == '–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç' or message.text == '–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç –∑–∞–Ω–æ–≤–æ':
        start_quiz(message)
    elif message.text in ['–°–≤—è–∑–∞—Ç—å—Å—è —Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º –∑–æ–æ–ø–∞—Ä–∫–∞', '–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤']:
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã
        pass
    elif user_states[user_id] == 'quiz_in_progress':
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –∫–≤–∏–∑–∞, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –µ–≥–æ –æ—Ç–≤–µ—Ç
        process_answer(message)
    else:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤–Ω–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∫–≤–∏–∑–∞ –∏–ª–∏ –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–∑—ã–≤–∞
        pass

@bot.message_handler(func=lambda message: True)
def process_answer(message):
    user_id = message.from_user.id

    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–¥–µ—Å—å
    if user_states[user_id] == 'awaiting_feedback':
        return

    question_idx = user_current_question[user_id]
    if question_idx < len(questions):
        _, answers = questions[question_idx]
        if message.text in answers:
            user_choices[user_id][answers[message.text]] += 1
            user_current_question[user_id] += 1
            ask_question(message)
        else:
            bot.send_message(user_id, "–í—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞ –∏–ª–∏ –Ω–∞—á–Ω–∏ —Ç–µ—Å—Ç –∑–∞–Ω–æ–≤–æ.")
    else:
        # –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ—Å—Ç–∞, —ç—Ç–æ—Ç –±–ª–æ–∫ –Ω–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç–∏–≥–Ω—É—Ç, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–∑—ã–≤–∞
        bot.send_message(user_id, "–ù–∞–∂–º–∏ '–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç –∑–∞–Ω–æ–≤–æ', —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞.")


def show_result(message):
    try:
        result_text, photo_url = calculate_result(message.chat.id)

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –∏ –ø—Ä–∏–∑—ã–≤–æ–º –∫ –¥–µ–π—Å—Ç–≤–∏—é
        caption_text = (f"–ú–æ—ë —Ç–æ—Ç–µ–º–Ω–æ–µ –∂–∏–≤–æ—Ç–Ω–æ–µ:\n{result_text}\n\n"
                        "–ê –∫–∞–∫–æ–µ –∂–∏–≤–æ—Ç–Ω–æ–µ —Ç—ã? –•–æ—á–µ—à—å —É–∑–Ω–∞—Ç—å?\n\n–ü—Ä–∏–º–∏ —É—á–∞—Å—Ç–∏–µ –≤ –≤–∏–∫—Ç–æ—Ä–∏–Ω–µ https://t.me/zoo_mskbot ‚¨áÔ∏è")

        # –°–æ–∑–¥–∞–µ–º InlineKeyboardMarkup –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –ø—Ä—è–º–æ –ø–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–µ–º
        markup_inline = types.InlineKeyboardMarkup()
        start_button = types.InlineKeyboardButton(text="–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ –≤–∏–∫—Ç–æ—Ä–∏–Ω–µ",
                                                  url="https://t.me/zoo_mskbot")
        markup_inline.add(start_button)

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º, –ø–æ–¥–ø–∏—Å—å—é –∏ –∫–Ω–æ–ø–∫–æ–π
        bot.send_photo(message.chat.id, photo_url, caption=caption_text, reply_markup=markup_inline, parse_mode='HTML')

        # –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ–≥—Ä–∞–º–º–µ –æ–ø–µ–∫–∏
        program_text = ("–°–ø–∞—Å–∏–±–æ –∑–∞ —É–¥–µ–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è!\n\n"
                        "–ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤–∞–º –ø–æ—É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ ¬´–í–æ–∑—å–º–∏ –∂–∏–≤–æ—Ç–Ω–æ–µ –ø–æ–¥ –æ–ø–µ–∫—É¬ª.\n\n"
                        "–≠—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—â—É—Ç–∏—Ç—å —Å–≤–æ—é –ø—Ä–∏—á–∞—Å—Ç–Ω–æ—Å—Ç—å –∫ –¥–µ–ª—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏—Ä–æ–¥—ã, —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –∂–∏–∑–Ω–∏ –ú–æ—Å–∫–æ–≤—Å–∫–æ–≥–æ –∑–æ–æ–ø–∞—Ä–∫–∞ –∏ –µ–≥–æ –æ–±–∏—Ç–∞—Ç–µ–ª–µ–π, "
                        "–≤–∏–¥–µ—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–≤–æ–µ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏. –û–ø–µ–∫–∞—Ç—å ‚Äì –∑–Ω–∞—á–∏—Ç –ø–æ–º–æ–≥–∞—Ç—å –ª—é–±–∏–º—ã–º –∂–∏–≤–æ—Ç–Ω—ã–º.")
        markup_inline_zoo = types.InlineKeyboardMarkup()
        zoo_url = "https://moscowzoo.ru/my-zoo/become-a-guardian/"
        more_button = types.InlineKeyboardButton(text="–£–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ", url=zoo_url)
        markup_inline_zoo.add(more_button)
        bot.send_message(message.chat.id, program_text, reply_markup=markup_inline_zoo, parse_mode="Markdown")

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–∞ –∏–ª–∏ —Å–≤—è–∑–∏ —Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º –∑–æ–æ–ø–∞—Ä–∫–∞
        markup_reply = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
        markup_reply.add('–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç –∑–∞–Ω–æ–≤–æ', '–°–≤—è–∑–∞—Ç—å—Å—è —Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º –∑–æ–æ–ø–∞—Ä–∫–∞', '–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤')
        bot.send_message(message.chat.id, "–ü—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç –∑–∞–Ω–æ–≤–æ, –Ω–∞–ø–∏—Å–∞—Ç—å —Å–≤–æ–∏ –≤–æ–ø—Ä–æ—Å—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É –∑–æ–æ–ø–∞—Ä–∫–∞ –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤:", reply_markup=markup_reply)
    except Exception as e:
        bot.send_message(message.chat.id, f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
if __name__ == '__main__':
    bot.infinity_polling()

